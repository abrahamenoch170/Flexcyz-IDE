"""
Pydantic models for all data structures in Flexcyz
"""

from datetime import datetime
from enum import Enum
from typing import Any, Dict, List, Optional, Union
from uuid import uuid4

from pydantic import BaseModel, Field, field_serializer


class TaskStatus(str, Enum):
    PENDING = "pending"
    IN_PROGRESS = "in_progress"
    COMPLETED = "completed"
    FAILED = "failed"
    WAITING = "waiting"  # Waiting for dependencies


class AgentType(str, Enum):
    PLANNER = "planner"
    ARCHITECT = "architect"
    CODER = "coder"
    REVIEWER = "reviewer"
    RESEARCHER = "researcher"
    GITHUB = "github"
    DEPLOYER = "deployer"


class FileAction(str, Enum):
    CREATE = "create"
    UPDATE = "update"
    DELETE = "delete"
    READ = "read"


class ProjectStatus(str, Enum):
    INITIALIZING = "initializing"
    PLANNING = "planning"
    CODING = "coding"
    REVIEWING = "reviewing"
    DEPLOYING = "deploying"
    COMPLETED = "completed"
    ERROR = "error"


# ============== TASK MODELS ==============

class TaskDependency(BaseModel):
    task_id: str
    required_status: TaskStatus = TaskStatus.COMPLETED


class Task(BaseModel):
    id: str = Field(default_factory=lambda: str(uuid4()))
    project_id: str
    description: str
    agent_type: AgentType
    status: TaskStatus = TaskStatus.PENDING
    priority: int = 1  # 1-5, higher = more important
    dependencies: List[str] = Field(default_factory=list)  # Task IDs
    created_at: datetime = Field(default_factory=datetime.utcnow)
    started_at: Optional[datetime] = None
    completed_at: Optional[datetime] = None
    result: Optional[Dict[str, Any]] = None
    error: Optional[str] = None
    metadata: Dict[str, Any] = Field(default_factory=dict)
    
    # For subtasks generated by parent
    parent_task_id: Optional[str] = None
    subtasks: List[str] = Field(default_factory=list)


# ============== FILE MODELS ==============

class FileOperation(BaseModel):
    id: str = Field(default_factory=lambda: str(uuid4()))
    task_id: str
    action: FileAction
    path: str
    content: Optional[str] = None
    created_at: datetime = Field(default_factory=datetime.utcnow)
    applied: bool = False


class FileState(BaseModel):
    path: str
    content: str
    language: Optional[str] = None
    last_modified: datetime = Field(default_factory=datetime.utcnow)
    operations_count: int = 0


# ============== AGENT MODELS ==============

class AgentConfig(BaseModel):
    name: str
    type: AgentType
    model: str  # e.g., "gpt-4-turbo", "groq/llama-3.1-70b"
    system_prompt: str
    temperature: float = 0.2
    max_tokens: int = 4096
    tools: List[str] = Field(default_factory=list)
    enabled: bool = True
    custom_settings: Dict[str, Any] = Field(default_factory=dict)


class AgentExecution(BaseModel):
    agent_type: AgentType
    task_id: str
    input_data: Dict[str, Any]
    output_data: Optional[Dict[str, Any]] = None
    started_at: datetime = Field(default_factory=datetime.utcnow)
    completed_at: Optional[datetime] = None
    tokens_used: int = 0
    cost: float = 0.0


# ============== PROJECT MODELS ==============

class ProjectConfig(BaseModel):
    name: str
    description: str
    tech_stack: List[str] = Field(default_factory=list)
    preferred_models: List[str] = Field(default_factory=list)
    auto_deploy: bool = False
    github_repo: Optional[str] = None


class Project(BaseModel):
    id: str = Field(default_factory=lambda: str(uuid4()))
    user_id: Optional[str] = None
    config: ProjectConfig
    status: ProjectStatus = ProjectStatus.INITIALIZING
    current_task_id: Optional[str] = None
    created_at: datetime = Field(default_factory=datetime.utcnow)
    updated_at: datetime = Field(default_factory=datetime.utcnow)
    
    # Relationships
    tasks: List[str] = Field(default_factory=list)
    files: Dict[str, FileState] = Field(default_factory=dict)
    
    # Context/Memory
    memory: Dict[str, Any] = Field(default_factory=dict)
    preferences_learned: Dict[str, Any] = Field(default_factory=dict)
    
    # Stats
    total_tokens_used: int = 0
    total_cost: float = 0.0


# ============== WEBSOCKET MODELS ==============

class WSMessageType(str, Enum):
    # Client -> Server
    PROMPT = "prompt"
    ACTION = "action"  # pause, resume, cancel
    FILE_EDIT = "file_edit"
    FEEDBACK = "feedback"
    
    # Server -> Client
    PROGRESS = "progress"
    TASK_UPDATE = "task_update"
    FILE_UPDATE = "file_update"
    CODE_GENERATED = "code_generated"
    ERROR = "error"
    COMPLETED = "completed"


class WebSocketMessage(BaseModel):
    type: WSMessageType
    project_id: Optional[str] = None
    payload: Dict[str, Any] = Field(default_factory=dict)
    timestamp: datetime = Field(default_factory=datetime.utcnow)


# ============== RESEARCH MODELS ==============

class ResearchQuery(BaseModel):
    query: str
    source: str = "tavily"  # tavily, exa, github
    results_count: int = 5


class ResearchResult(BaseModel):
    title: str
    url: str
    content: str
    source: str
    relevance_score: float = 0.0
    code_snippets: List[str] = Field(default_factory=list)


# ============== DEPLOYMENT MODELS ==============

class DeploymentTarget(str, Enum):
    VERCEL = "vercel"
    RAILWAY = "railway"
    SUPABASE = "supabase"
    GITHUB_PAGES = "github_pages"


class DeploymentConfig(BaseModel):
    target: DeploymentTarget
    environment_variables: Dict[str, str] = Field(default_factory=dict)
    build_command: Optional[str] = None
    output_dir: Optional[str] = None


class DeploymentResult(BaseModel):
    success: bool
    url: Optional[str] = None
    logs: List[str] = Field(default_factory=list)
    error: Optional[str] = None


# ============== PLANNER OUTPUT ==============

class PlanStep(BaseModel):
    id: str = Field(default_factory=lambda: str(uuid4()))
    description: str
    agent_type: AgentType
    dependencies: List[str] = Field(default_factory=list)
    priority: int = 1
    expected_files: List[str] = Field(default_factory=list)


class ProjectPlan(BaseModel):
    summary: str
    steps: List[PlanStep]
    tech_stack: List[str] = Field(default_factory=list)
    estimated_duration: Optional[str] = None


# ============== CODER OUTPUT ==============

class CodeFile(BaseModel):
    path: str
    content: str
    language: str
    explanation: Optional[str] = None


class CodeGenerationResult(BaseModel):
    files: List[CodeFile]
    dependencies_to_install: List[str] = Field(default_factory=list)
    commands_to_run: List[str] = Field(default_factory=list)
    explanation: str


# ============== REVIEW OUTPUT ==============

class CodeIssue(BaseModel):
    severity: str  # error, warning, suggestion
    file_path: str
    line_number: Optional[int] = None
    message: str
    suggested_fix: Optional[str] = None


class ReviewResult(BaseModel):
    passed: bool
    issues: List[CodeIssue] = Field(default_factory=list)
    score: float = 0.0  # 0-100
    summary: str


# ============== REQUEST/RESPONSE MODELS ==============

class CreateProjectRequest(BaseModel):
    prompt: str
    config: Optional[ProjectConfig] = None


class ProjectResponse(BaseModel):
    project: Project
    message: str


class TaskResponse(BaseModel):
    task: Task
    message: str


class FileListResponse(BaseModel):
    project_id: str
    files: List[FileState]


class AgentStatus(BaseModel):
    agent_type: AgentType
    status: str  # idle, busy, error
    current_task: Optional[str] = None
    queue_size: int = 0
